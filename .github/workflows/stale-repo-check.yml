name: Check for Stale Repos

on:
  schedule:
    - cron: '0 0 1 * *'  # Monthly on 1st
  workflow_dispatch:

jobs:
  check-stale:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Extract GitHub repos from README
        id: extract
        run: |
          grep -oP 'https://github.com/[\w-]+/[\w-]+' README.md | sort -u > repos.txt
          echo "Found $(wc -l < repos.txt) unique repositories"

      - name: Check last commit dates
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# Repositories with no commits in last 2 years" > stale-repos.md
          echo "" >> stale-repos.md
          while IFS= read -r repo_url; do
            repo=$(echo "$repo_url" | sed 's|https://github.com/||')
            echo "Checking $repo..."
            last_commit=$(gh api "repos/$repo/commits?per_page=1" --jq '.[0].commit.committer.date' 2>/dev/null || echo "ERROR")
            if [ "$last_commit" != "ERROR" ]; then
              commit_year=$(date -d "$last_commit" +%Y 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$last_commit" +%Y 2>/dev/null)
              current_year=$(date +%Y)
              if [ $((current_year - commit_year)) -ge 2 ]; then
                echo "- [$repo]($repo_url) - Last commit: $last_commit" >> stale-repos.md
              fi
            fi
          done < repos.txt

      - name: Create issue if stale repos found
        if: success()
        run: |
          if [ $(wc -l < stale-repos.md) -gt 2 ]; then
            gh issue create \
              --title "⚠️ Stale repositories detected" \
              --body-file stale-repos.md \
              --label "maintenance,stale-repos"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
